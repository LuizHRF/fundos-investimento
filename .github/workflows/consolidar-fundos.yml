# Workflow: Consolidar dados de fundos CVM e enviar para Google Drive
#
# Executa diariamente às 08:30 horário de Brasília (11:30 UTC)
# Também pode ser executado manualmente via GitHub UI

name: Consolidar Fundos CVM

on:
  schedule:
    # 08:30 BRT = 11:30 UTC (Brasília = UTC-3)
    - cron: '30 11 * * *'

  # Permite execução manual pelo GitHub UI
  workflow_dispatch:

jobs:
  consolidar-e-upload:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout do repositório
      - name: Checkout código
        uses: actions/checkout@v4

      # 2. Setup Python
      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # 3. Instalar dependências
      - name: Instalar dependências
        run: pip install -r requirements.txt

      # 4. Executar consolidação (força download de dados atualizados)
      - name: Consolidar dados CVM
        run: python main.py consolidate --force

      # 5. Upload para Google Drive
      - name: Upload para Google Drive
        env:
          GOOGLE_TOKEN_JSON: ${{ secrets.GOOGLE_TOKEN_JSON }}
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
        run: python main.py upload

      # 6. Salvar artefatos (backup no GitHub)
      - name: Salvar CSVs como artefatos
        uses: actions/upload-artifact@v4
        with:
          name: fundos-cvm-${{ github.run_number }}
          path: |
            output/fundos.csv
            output/composicao_carteira.csv
          retention-days: 7
